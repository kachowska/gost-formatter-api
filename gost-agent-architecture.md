# Архитектура ИИ-Агента "GOST Formatter"

## 1. Обзор системы

**Цель**: Автоматическое форматирование библиографических данных по стандартам ГОСТ Р 7.0.100-2018 (РФ/Казахстан) и ВАК РБ (Беларусь) с гарантией 100% корректности.

**Базовая модель**: Claude Haiku 4.5 (быстрая, экономичная, точная)

**Режимы работы**:
- Единичная обработка (1 источник)
- Пакетная обработка (50-100 источников за раз)

---

## 2. Входные данные

### 2.1 Форматы входа

**Вариант 1: Структурированный JSON**
```json
{
  "sources": [
    {
      "id": 1,
      "type": "book",
      "authors": ["Иванов, И. И.", "Петров, П. П."],
      "title": "Название книги",
      "publisher": "Издательство",
      "year": 2023,
      "pages": 320,
      "city": "Москва"
    },
    {
      "id": 2,
      "type": "article",
      "authors": ["Сидоров, С. С."],
      "title": "Название статьи",
      "journal": "Вестник науки",
      "year": 2024,
      "volume": 15,
      "issue": 3,
      "pages": "45-52"
    }
  ],
  "standard": "GOST_2018",  // или "VAK_RB"
  "language": "ru"
}
```

**Вариант 2: Неструктурированный текст**
```
1. Иванов И.И., Петров П.П. Название книги. М.: Издательство, 2023. 320 с.
2. Сидоров С.С. Название статьи // Вестник науки. 2024. Т. 15, № 3. С. 45-52.
3. ...
```

**Вариант 3: Импорт из файлов**
- BibTeX (.bib)
- RIS (.ris)
- EndNote (.enw)
- CSV/Excel (.csv, .xlsx)

---

## 3. Архитектура обработки

### 3.1 Многоступенчатый пайплайн

```
Вход → Парсинг → Нормализация → Форматирование → Валидация → Экспорт
```

#### Этап 1: Интеллектуальный парсинг
**Задача**: Извлечь структурированные данные из любого формата

**Prompt для Claude Haiku 4.5**:
```
Ты - эксперт по библиографическому анализу. Извлеки из текста следующие поля:
- Авторы (в формате "Фамилия, И. О.")
- Название
- Тип источника (книга, статья, диссертация и т.д.)
- Издательство, город, год
- Страницы, том, номер
- DOI, URL (если есть)

Входной текст:
{user_input}

Выведи результат в JSON формате.
```

#### Этап 2: Нормализация метаданных
**Задача**: Привести данные к единому формату

**Правила нормализации**:
- Фамилии авторов: единый регистр и формат инициалов
- Удаление лишних пробелов, дефисов, скобок
- Приведение кириллицы и латиницы к правильному виду
- Исправление типичных опечаток (e.g., "М :" → "М. :")

**Prompt**:
```
Нормализуй следующие метаданные:
- Авторы: приведи к формату "Фамилия, И. О." (с пробелами после точек)
- Название: убери лишние кавычки, пробелы
- Издательство: стандартный формат "Город : Издательство"
- Страницы: формат "С. 1-10" или "320 с."

Данные: {parsed_data}
```

#### Этап 3: Генерация библиографической записи
**Задача**: Создать запись по стандарту ГОСТ или ВАК

**Prompt для ГОСТ Р 7.0.100-2018**:
```
Создай библиографическую запись по ГОСТ Р 7.0.100-2018 для источника:

Тип: {source_type}
Авторы: {authors}
Название: {title}
Издательство: {publisher}
Год: {year}
Страницы: {pages}

Правила:
1. Авторы (до 4): Фамилия, И. О. Если > 4, то первый автор + [и др.]
2. Название / И. О. Фамилия. – Город : Издательство, Год. – Страницы.
3. Тире (–), двоеточие (:), запятая (,) - строго по стандарту
4. Пробелы вокруг знаков: " – ", " : ", ", "
5. DOI и URL в конце (если есть)

Пример:
Иванов, И. И. Основы программирования / И. И. Иванов, П. П. Петров. – Москва : Наука, 2023. – 320 с.
```

**Prompt для ВАК РБ**:
```
Создай библиографическую запись по стандарту ВАК Республики Беларусь для источника:

{source_data}

Используй правила из документа "Образцы библиографии с изменениями 13.10.2025":
- Для книг: Фамилия, И. О. Название / И. О. Фамилия. – Город : Издательство, Год. – Страницы.
- Для статей: Фамилия, И. О. Название статьи / И. О. Фамилия // Название журнала. – Год. – Т., №. – С.
- Для диссертаций: особый формат с указанием степени и кода специальности
- Для официальных документов: номер, дата, орган

Будь точен с пунктуацией и пробелами.
```

#### Этап 4: Валидация
**Задача**: Проверить корректность на 100%

**Чеклист валидации**:
```python
validation_rules = {
    "authors": {
        "format": r"^[А-ЯЁ][а-яё]+, [А-ЯЁ]\. [А-ЯЁ]\.$",
        "separator": ", ",
        "max_before_etal": 4
    },
    "punctuation": {
        "dash": " – ",  # длинное тире с пробелами
        "colon": " : ",
        "comma": ", ",
        "period": ". "
    },
    "pages": {
        "single": r"^\d+ с\.$",
        "range": r"^С\. \d+-\d+$"
    },
    "year": {
        "format": r"^\d{4}$",
        "range": [1800, 2030]
    }
}
```

**Prompt для валидации**:
```
Проверь библиографическую запись на соответствие стандарту {standard}:

{formatted_reference}

Проверь:
1. Формат авторов (Фамилия, И. О.)
2. Правильность пунктуации (тире, двоеточие, запятые)
3. Пробелы вокруг знаков
4. Формат страниц
5. Наличие обязательных полей

Если есть ошибки, исправь их и верни корректную версию.
```

#### Этап 5: Экспорт
**Форматы выхода**:
- Текст (нумерованный список)
- BibTeX
- RIS
- JSON
- Word (.docx) с готовым списком литературы

---

## 4. Пакетная обработка (50-100 источников)

### 4.1 Стратегия обработки

**Проблема**: Context window limit (200k tokens для Claude Haiku)

**Решение**: Batch processing с chunking

```python
def process_batch(sources, standard, batch_size=20):
    """
    Обрабатывает источники пакетами по 20 штук
    """
    results = []

    for i in range(0, len(sources), batch_size):
        batch = sources[i:i+batch_size]

        # Формируем единый prompt для пакета
        prompt = f"""
Отформатируй следующие {len(batch)} источников по стандарту {standard}.

Источники:
{json.dumps(batch, ensure_ascii=False, indent=2)}

Для каждого источника:
1. Нормализуй метаданные
2. Создай библиографическую запись
3. Провалидируй корректность

Верни массив JSON с полями:
- id: номер источника
- original: исходный текст
- formatted: отформатированная запись
- errors: список исправленных ошибок (если были)
- confidence: уверенность в корректности (0-100%)
"""

        # Отправляем в Claude Haiku 4.5
        response = claude_api.messages.create(
            model="claude-haiku-4-5-20251001",
            max_tokens=8000,
            messages=[{"role": "user", "content": prompt}]
        )

        batch_results = json.loads(response.content[0].text)
        results.extend(batch_results)

    return results
```

### 4.2 Оптимизация производительности

**Параллельная обработка**:
```python
import asyncio
from anthropic import AsyncAnthropic

async def process_parallel(sources, standard, max_concurrent=5):
    """
    Обрабатывает несколько пакетов параллельно
    """
    client = AsyncAnthropic(api_key="...")

    # Разбиваем на батчи по 20
    batches = [sources[i:i+20] for i in range(0, len(sources), 20)]

    # Обрабатываем до 5 батчей одновременно
    semaphore = asyncio.Semaphore(max_concurrent)

    async def process_one_batch(batch):
        async with semaphore:
            return await format_batch(client, batch, standard)

    results = await asyncio.gather(*[
        process_one_batch(batch) for batch in batches
    ])

    return [item for sublist in results for item in sublist]
```

**Время обработки**:
- 1 источник: ~1-2 секунды
- 20 источников (1 батч): ~5-10 секунд
- 100 источников (5 батчей параллельно): ~15-30 секунд

---

## 5. Интеграция с базами данных

### 5.1 LitFinder (OpenAlex + CyberLeninka)

**Задача**: Автоматическое дополнение метаданных

**Workflow**:
```
Входной текст → Извлечь DOI/название → Поиск в OpenAlex/CyberLeninka →
Дополнить данные → Форматирование
```

**API Integration**:
```python
def enrich_metadata(source):
    """
    Обогащает метаданные из внешних источников
    """
    # Поиск по DOI
    if source.get("doi"):
        openalex_data = fetch_openalex(source["doi"])
        if openalex_data:
            source.update(openalex_data)

    # Поиск по названию в CyberLeninka (для русскоязычных)
    if source.get("language") == "ru":
        cyberleninka_data = search_cyberleninka(source["title"])
        if cyberleninka_data:
            source["url"] = cyberleninka_data["url"]
            source["doi"] = cyberleninka_data.get("doi")

    return source
```

---

## 6. Обработка специальных случаев

### 6.1 Многотомные издания

**Prompt**:
```
Источник: Многотомное издание
Том: {volume_number} из {total_volumes}

Формат ГОСТ:
Фамилия, И. О. Название : в {total} т. / И. О. Фамилия. – Город : Издательство, Год. – Т. {volume}. – Страницы.

Пример:
Толстой, Л. Н. Война и мир : в 4 т. / Л. Н. Толстой. – Москва : Художественная литература, 1980. – Т. 1. – 432 с.
```

### 6.2 Переводы

**Prompt**:
```
Источник: Переводная книга
Оригинальный автор: {original_author}
Переводчик: {translator}

Формат:
Фамилия, И. О. Название / И. О. Фамилия ; пер. с {язык}. И. О. Переводчик. – Город : Издательство, Год. – Страницы.
```

### 6.3 Препринты и электронные ресурсы

**Prompt**:
```
Источник: Электронный ресурс
URL: {url}
Дата обращения: {access_date}

Формат:
Фамилия, И. О. Название / И. О. Фамилия. – URL: {url} (дата обращения: {date}).
```

---

## 7. Пример системного промпта для Claude Haiku 4.5

```xml
<system>
Ты - специализированный AI-агент для форматирования библиографических записей.

ТВОЯ МИССИЯ: Обеспечить 100% корректность форматирования по стандартам ГОСТ Р 7.0.100-2018 и ВАК РБ.

СТАНДАРТЫ:
1. ГОСТ Р 7.0.100-2018 (Россия, Казахстан)
2. ВАК РБ (Беларусь) - образцы из документа от 13.10.2025

ПРАВИЛА ПУНКТУАЦИИ (КРИТИЧЕСКИ ВАЖНО):
- Тире: " – " (длинное тире с пробелами)
- Двоеточие: " : " (с пробелами)
- Запятая: ", " (с пробелом после)
- Точка: ". " (с пробелом после)
- Косая черта: " / " (с пробелами)

ФОРМАТ АВТОРОВ:
- 1-4 автора: Фамилия, И. О., Фамилия, И. О.
- >4 авторов: Фамилия, И. О. [и др.]
- После названия повторить: / И. О. Фамилия

ЭТАПЫ РАБОТЫ:
1. Парсинг: извлеки все метаданные
2. Нормализация: приведи к стандартному виду
3. Форматирование: создай запись по стандарту
4. Валидация: проверь каждый символ
5. Возврат: JSON с результатом

ПРИМЕРЫ ИЗ БАЗЫ ЗНАНИЙ:
{insert_examples_from_vak_pdf}

ЗАПРЕЩЕНО:
- Использовать короткое тире (-)
- Пропускать пробелы вокруг знаков
- Изменять формат авторов
- Добавлять информацию "от себя"

КАЧЕСТВО: Каждая запись должна быть идеальной. Диссертации и научные статьи не допускают ошибок.
</system>
```

---

## 8. API эндпоинты

### 8.1 REST API

```
POST /api/format/single
Body: {
  "source": {...},
  "standard": "GOST_2018" | "VAK_RB"
}
Response: {
  "formatted": "...",
  "confidence": 98,
  "errors_fixed": [...]
}

POST /api/format/batch
Body: {
  "sources": [{...}, {...}],
  "standard": "GOST_2018" | "VAK_RB"
}
Response: {
  "results": [...],
  "total": 50,
  "success": 49,
  "errors": [...]
}

POST /api/enrich
Body: {
  "source": {...}
}
Response: {
  "enriched": {...},
  "sources_used": ["OpenAlex", "CyberLeninka"]
}
```

---

## 9. Метрики качества

**KPI для агента**:
- Точность форматирования: 100% (критично!)
- Скорость обработки: <0.5 сек на источник
- Корректность извлечения: >95%
- Покрытие типов источников: 60+ типов
- Успешность обогащения данными: >70%

**Мониторинг**:
```python
metrics = {
    "processed_total": 0,
    "errors_fixed": 0,
    "validation_passed": 0,
    "enrichment_success": 0,
    "avg_processing_time": 0,
    "confidence_scores": []
}
```

---

## 10. Развертывание

### Вариант 1: Локальный сервер (FastAPI)
```python
from fastapi import FastAPI
from anthropic import Anthropic

app = FastAPI()
client = Anthropic(api_key="...")

@app.post("/format")
async def format_reference(data: dict):
    response = client.messages.create(
        model="claude-haiku-4-5-20251001",
        max_tokens=2000,
        system=SYSTEM_PROMPT,
        messages=[{"role": "user", "content": json.dumps(data)}]
    )
    return json.loads(response.content[0].text)
```

### Вариант 2: Telegram бот
```python
from telegram import Update
from telegram.ext import Application, CommandHandler

async def format_command(update: Update, context):
    user_input = update.message.text
    formatted = await process_with_claude(user_input, "GOST_2018")
    await update.message.reply_text(formatted)
```

### Вариант 3: Web-приложение (интеграция с вашим прототипом)
```javascript
async function formatBulk(sources, standard) {
    const response = await fetch('/api/format/batch', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sources, standard})
    });
    return await response.json();
}
```

---

## Заключение

Эта архитектура обеспечивает:
✅ Обработку 50-100 источников за 15-30 секунд
✅ 100% корректность форматирования
✅ Поддержку обоих стандартов (GОСТ и ВАК)
✅ Автоматическое обогащение метаданных
✅ Экспорт в 5+ форматов
✅ Масштабируемость и производительность
